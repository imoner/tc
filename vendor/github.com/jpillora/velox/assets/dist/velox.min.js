// velox - v0.2.12 - https://github.com/jpillora/velox
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2016
!function(){!function(t){if(!("EventSource"in t)){var e=/^(\s|\u00A0)+|(\s|\u00A0)+$/g,n=function(t){function n(t){o._pollTimer=setTimeout(function(){r.call(o)},t)}function r(){try{if(o.readyState==o.CLOSED)return;var t=new XMLHttpRequest;t.open("GET",o.URL,!0),t.setRequestHeader("Accept","text/event-stream"),t.setRequestHeader("Cache-Control","no-cache"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),null!=a&&t.setRequestHeader("Last-Event-ID",a),h="",t.timeout=5e4,t.onreadystatechange=function(){if(3==this.readyState||4==this.readyState&&200==this.status){o.readyState==o.CONNECTING&&(o.readyState=o.OPEN,o.dispatchEvent("open",{type:"open"}));var t="";try{t=this.responseText||""}catch(r){}var c=t.substr(h.length).split("\n"),p="message",l=[],u=0,f="";for(h=t;u<c.length;u++)if(f=c[u].replace(e,""),0==f.indexOf("event"))p=f.replace(/event:?\s*/,"");else if(0==f.indexOf("retry"))retry=parseInt(f.replace(/retry:?\s*/,"")),isNaN(retry)||(s=retry);else if(0==f.indexOf("data"))l.push(f.replace(/data:?\s*/,""));else if(0==f.indexOf("id:"))a=f.replace(/id:?\s*/,"");else if(0==f.indexOf("id"))a=null;else if(""==f&&l.length){var d=new i(l.join("\n"),o.url,a);o.dispatchEvent(p,d),l=[],p="message"}4==this.readyState&&n(s)}else o.readyState!==o.CLOSED&&(4==this.readyState?(o.readyState=o.CONNECTING,o.dispatchEvent("error",{type:"error"}),n(s)):0==this.readyState&&n(s))},t.send(),setTimeout(function(){t.abort()},t.timeout),o._xhr=t}catch(r){o.dispatchEvent("error",{type:"error",data:r.message})}}var o=this,s=500,a=null,h="";if(!t||"string"!=typeof t)throw new SyntaxError("Not enough arguments");this.URL=t,this.readyState=this.CONNECTING,this._pollTimer=null,this._xhr=null,r()};n.prototype={close:function(){this.readyState=this.CLOSED,clearInterval(this._pollTimer),this._xhr.abort()},CONNECTING:0,OPEN:1,CLOSED:2,dispatchEvent:function(t,e){var n=this["_"+t+"Handlers"];if(n)for(var i=0;i<n.length;i++)n[i].call(this,e);this["on"+t]&&this["on"+t].call(this,e)},addEventListener:function(t,e){this["_"+t+"Handlers"]||(this["_"+t+"Handlers"]=[]),this["_"+t+"Handlers"].push(e)},removeEventListener:function(t,e){var n=this["_"+t+"Handlers"];if(n)for(var i=n.length-1;i>=0;--i)if(n[i]===e){n.splice(i,1);break}},onerror:null,onmessage:null,onopen:null,readyState:0,URL:""};var i=function(t,e,n){this.data=t,this.origin=e,this.lastEventId=n||""};i.prototype={data:null,type:"message",lastEventId:"",origin:""},"module"in t&&(module.exports=n),t.EventSource=n}}(this);var t,e=this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);n.prototype=e.prototype,t.prototype=new n},n=Error;!function(t){function i(t,e){switch(typeof t){case"undefined":case"boolean":case"string":case"number":return t===e;case"object":if(null===t)return null===e;if(c(t)){if(!c(e)||t.length!==e.length)return!1;for(var n=0,r=t.length;r>n;n++)if(!i(t[n],e[n]))return!1;return!0}var o=p(e),s=o.length;if(p(t).length!==s)return!1;for(var n=0;s>n;n++)if(!i(t[n],e[n]))return!1;return!0;default:return!1}}function r(t){for(var e,n=0,i=t.length;i>n;){e=t.charCodeAt(n);{if(!(e>=48&&57>=e))return!1;n++}}return!0}function o(t,e,n){for(var i,o,s=!1,a=0,h=e.length;h>a;){i=e[a],a++;for(var p=i.path||"",v=p.split("/"),y=t,g=1,E=v.length,O=void 0;;){if(o=v[g].replace(/\u2603/g,"/"),n&&void 0===O&&(void 0===y[o]?O=v.slice(0,g).join("/"):g==E-1&&(O=i.path),void 0!==O&&this.validator(i,a-1,t,O)),g++,void 0===o&&g>=E){s=f[i.op].call(i,y,o,t);break}if(c(y)){if("-"===o)o=y.length;else{if(n&&!r(o))throw new d("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a-1,i.path,i);o=parseInt(o,10)}if(g>=E){if(n&&"add"===i.op&&o>y.length)throw new d("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a-1,i.path,i);s=u[i.op].call(i,y,o,t);break}}else if(o&&-1!=o.indexOf("~")&&(o=o.replace(/~1/g,"/").replace(/~0/g,"~")),g>=E){s=l[i.op].call(i,y,o,t);break}if(!y){console.warning("slashes in object keys not supported");break}y=y[o]}}return s}function s(t){if(void 0===t)return!0;if("array"==typeof t||"object"==typeof t)for(var e in t)if(s(t[e]))return!0;return!1}function a(e,n,i,r){if("object"!=typeof e||null===e||c(e))throw new d("Operation is not an object","OPERATION_NOT_AN_OBJECT",n,e,i);if(!l[e.op])throw new d("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",n,e,i);if("string"!=typeof e.path)throw new d("Operation `path` property is not a string","OPERATION_PATH_INVALID",n,e,i);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new d("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",n,e,i);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new d("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",n,e,i);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&s(e.value))throw new d("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",n,e,i);if(i)if("add"==e.op){var o=e.path.split("/").length,a=r.split("/").length;if(o!==a+1&&o!==a)throw new d("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",n,e,i)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new d("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",n,e,i)}else if("move"===e.op||"copy"===e.op){var h={op:"_get",path:e.from,value:void 0},p=t.validate([h],i);if(p&&"OPERATION_PATH_UNRESOLVABLE"===p.name)throw new d("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",n,e,i)}}function h(t,e){try{if(!c(t))throw new d("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)e=JSON.parse(JSON.stringify(e)),o.call(this,e,t,!0);else for(var n=0;n<t.length;n++)this.validator(t[n],n)}catch(i){if(i instanceof d)return i;throw i}}if(!t.apply){var c,p=function(){return Object.keys?Object.keys:function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return e}}(),l={add:function(t,e){return t[e]=this.value,!0},remove:function(t,e){return delete t[e],!0},replace:function(t,e){return t[e]=this.value,!0},move:function(t,e,n){var i={op:"_get",path:this.from};return o(n,[i]),o(n,[{op:"remove",path:this.from}]),o(n,[{op:"add",path:this.path,value:i.value}]),!0},copy:function(t,e,n){var i={op:"_get",path:this.from};return o(n,[i]),o(n,[{op:"add",path:this.path,value:i.value}]),!0},test:function(t,e){return i(t[e],this.value)},_get:function(t,e){this.value=t[e]}},u={add:function(t,e){return t.splice(e,0,this.value),!0},remove:function(t,e){return t.splice(e,1),!0},replace:function(t,e){return t[e]=this.value,!0},move:l.move,copy:l.copy,test:l.test,_get:l._get},f={add:function(t){f.remove.call(this,t);for(var e in this.value)this.value.hasOwnProperty(e)&&(t[e]=this.value[e]);return!0},remove:function(t){for(var e in t)t.hasOwnProperty(e)&&l.remove.call(this,t,e);return!0},replace:function(t){return o(t,[{op:"remove",path:this.path}]),o(t,[{op:"add",path:this.path,value:this.value}]),!0},move:l.move,copy:l.copy,test:function(t){return JSON.stringify(t)===JSON.stringify(this.value)},_get:function(t){this.value=t}};c=Array.isArray?Array.isArray:function(t){return t.push&&"number"==typeof t.length},t.apply=o;var d=function(t){function n(e,n,i,r,o){t.call(this,e),this.message=e,this.name=n,this.index=i,this.operation=r,this.tree=o}return e(n,t),n}(n);t.JsonPatchError=d,t.Error=d,t.validator=a,t.validate=h}}(t||(t={})),"undefined"!=typeof exports&&(exports.apply=t.apply,exports.validate=t.validate,exports.validator=t.validator,exports.JsonPatchError=t.JsonPatchError,exports.Error=t.Error),function(e,n){function i(t){if(l.online=navigator.onLine,l.online)for(var e=0;e<u.length;e++)u[e].retrying&&u[e].retry()}function r(t,n,i){switch(t){case l.WS:if(!e.WebSocket)throw"This browser does not support WebSockets";this.ws=!0;break;case l.SSE:this.sse=!0;break;default:throw"Type must be velox.WS or velox.SSE"}if(n||(n="/velox"),this.url=n,!i||"object"!=typeof i)throw"Invalid object";this.obj=i,this.id="",this.version=0,this.onupdate=function(){},this.onerror=function(){},this.onconnect=function(){},this.ondisconnect=function(){},this.onchange=function(){},this.connected=!1,this.connect()}var o="v2",s=45e3,a=25e3,h=5e3,c=3e4,p=3e4,l=function(t,n){return l.DEFAULT!==l.SSE&&e.WebSocket?l.ws(t,n):l.sse(t,n)};l.WS={ws:!0},l.ws=function(t,e){return new r(l.WS,t,e)},l.SSE=l.DEFAULT={sse:!0},l.sse=function(t,e){return new r(l.SSE,t,e)},l.proto=o,l.online=!0;var u=l.connections=[];e.addEventListener("online",i),e.addEventListener("offline",i);var f=function(t,e){if(!t||"object"!=typeof t||!e||"object"!=typeof e)return e;var n;if(t instanceof Array&&e instanceof Array)for(;t.length>e.length;)t.pop();else for(n in t)"$"===n[0]||n in e||delete t[n];for(n in e)t[n]=f(t[n],e[n]);return t},d=["message","error","open","close"],v=e.location;r.prototype={connect:function(){-1===u.indexOf(this)&&u.push(this),this.retrying=!0,this.retry()},retry:function(){if(clearTimeout(this.retry.t),this.conn&&this.cleanup(),this.retrying){this.delay||(this.delay=100);var t=this.url;/^(ws|http)s?:/.test(t)||(t=v.protocol+"//"+v.host+t),this.ws&&(t=t.replace(/^http/,"ws"));var e=[];this.version&&e.push("v="+this.version),this.id&&e.push("id="+this.id),e.length&&(t+=(/\?/.test(t)?"&":"?")+e.join("&")),this.ws?this.conn=new WebSocket(t):this.conn=new EventSource(t,{withCredentials:!0});var n=this;d.forEach(function(t){n.conn["on"+t]=n["conn"+t].bind(n)}),this.sleepCheck.last=null,this.sleepCheck()}},disconnect:function(){var t=u.indexOf(this);t>=0&&u.splice(t,1),this.retrying=!1,this.cleanup()},cleanup:function(){if(clearTimeout(this.pingout.t),this.conn){var t=this.conn;this.conn=null,d.forEach(function(e){t["on"+e]=null}),t&&t.readyState!==t.CLOSED&&t.close(),this.statusCheck()}},send:function(t){var e=this.conn;return e&&e instanceof WebSocket&&e.readyState===e.OPEN?e.send(t):void 0},pingin:function(){clearTimeout(this.pingin.t),this.pingin.t=setTimeout(this.retry.bind(this),s)},pingout:function(){this.send("ping"),clearTimeout(this.pingout.t),this.pingout.t=setTimeout(this.pingout.bind(this),a)},sleepCheck:function(){var t=this.sleepCheck;clearInterval(t.t);var e=Date.now(),n=t.last&&e-t.last>c;t.last=e,t.t=setTimeout(this.sleepCheck.bind(this),h),n&&this.retry()},statusCheck:function(t){var e=!!this.connected,n=!(!this.conn||this.conn.readyState!==this.conn.OPEN);e!==n&&(this.connected=n,this.onchange(this.connected),this.connected?this.onconnect():this.ondisconnect())},connmessage:function(e){var n;try{n=JSON.parse(e.data)}catch(i){return void this.onerror(i)}return n.ping?void this.pingin():(n.id&&(this.id=n.id),n.body&&this.obj?(n.delta?t.apply(this.obj,n.body):f(this.obj,n.body),"function"==typeof this.obj.$apply&&this.obj.$apply(),this.onupdate(this.obj),this.version=n.version,void(this.delay=100)):void this.onerror("null objects"))},connopen:function(){this.statusCheck(),this.pingin(),this.pingout()},connclose:function(){this.statusCheck(),this.delay=Math.min(p,2*this.delay),this.retrying&&l.online&&(this.retry.t=setTimeout(this.connect.bind(this),this.delay))},connerror:function(t){this.conn&&this.conn instanceof EventSource?(this.conn.close(),this.connclose()):(this.statusCheck(),this.onerror(t))}},e.velox=l}(window,document,void 0)}();
